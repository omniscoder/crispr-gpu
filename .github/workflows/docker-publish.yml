name: Docker (CPU) publish

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (tag/branch/SHA)"
        required: true
        default: "v0.2.0"
      publish_latest:
        description: "Also push :latest (only for stable semver tags)"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  publish-cpu:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref_name }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Git metadata
        id: git
        shell: bash
        run: |
          set -euo pipefail
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Compute tags/refs
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          ref_in="${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref_name }}"
          want_latest="${{ github.event_name == 'workflow_dispatch' && inputs.publish_latest || 'true' }}"

          tag="$ref_in"
          if [[ "$tag" =~ ^refs/tags/(.+)$ ]]; then tag="${BASH_REMATCH[1]}"; fi
          if [[ "$tag" =~ ^refs/heads/(.+)$ ]]; then tag="${BASH_REMATCH[1]}"; fi
          tag="${tag//\//-}"

          publish_latest=false
          is_semver=false
          if [[ "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            is_semver=true
          fi
          if [[ "$is_semver" == "true" ]] && [[ "$want_latest" == "true" ]]; then
            publish_latest=true
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "publish_latest=$publish_latest" >> "$GITHUB_OUTPUT"
          echo "is_semver=$is_semver" >> "$GITHUB_OUTPUT"

      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}-cpu
          tags: |
            type=raw,value=${{ steps.vars.outputs.tag }}
            type=raw,value=latest,enable=${{ steps.vars.outputs.publish_latest }}

      - name: Resolve existing digest (avoid mutating stable tags)
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          image="ghcr.io/${{ github.repository }}-cpu"
          tag="${{ steps.vars.outputs.tag }}"

          if [[ "${{ steps.vars.outputs.is_semver }}" != "true" ]]; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if docker buildx imagetools inspect "${image}:${tag}" >/dev/null 2>&1; then
            digest="$(docker buildx imagetools inspect "${image}:${tag}" --format '{{.Digest}}')"
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "digest=$digest" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: docker/build-push-action@v5
        id: build
        if: steps.resolve.outputs.exists != 'true'
        with:
          context: .
          file: docker/Dockerfile.cpu
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            CRISPR_GPU_IMAGE_REPOSITORY=ghcr.io/${{ github.repository }}-cpu
            CRISPR_GPU_GIT_REF=${{ steps.vars.outputs.tag }}
            CRISPR_GPU_GIT_SHA=${{ steps.git.outputs.sha }}
            CRISPR_GPU_GITHUB_RUN_ID=${{ github.run_id }}

      - name: Update :latest tag without rebuild
        if: steps.resolve.outputs.exists == 'true' && steps.vars.outputs.publish_latest == 'true'
        shell: bash
        run: |
          set -euo pipefail
          image="ghcr.io/${{ github.repository }}-cpu"
          digest="${{ steps.resolve.outputs.digest }}"
          docker buildx imagetools create -t "${image}:latest" "${image}@${digest}"

      - name: Final image digest
        id: image
        shell: bash
        run: |
          set -euo pipefail
          image="ghcr.io/${{ github.repository }}-cpu"
          digest="${{ steps.build.outputs.digest }}"
          if [[ "${{ steps.resolve.outputs.exists }}" == "true" ]]; then
            digest="${{ steps.resolve.outputs.digest }}"
          fi
          if [[ -z "$digest" ]]; then
            echo "Unable to determine image digest" >&2
            exit 1
          fi
          echo "image=$image" >> "$GITHUB_OUTPUT"
          echo "digest=$digest" >> "$GITHUB_OUTPUT"

      - uses: sigstore/cosign-installer@v3

      - name: Cosign keyless sign (digest)
        shell: bash
        run: |
          set -euo pipefail
          cosign sign --yes "${{ steps.image.outputs.image }}@${{ steps.image.outputs.digest }}"

      - name: Compute cosign signature reference
        id: cosign
        shell: bash
        run: |
          set -euo pipefail
          image="${{ steps.image.outputs.image }}"
          digest="${{ steps.image.outputs.digest }}"

          sig_ref="$(cosign triangulate --type signature "${image}@${digest}" 2>/dev/null || true)"
          if [[ -z "$sig_ref" ]]; then
            hex="${digest#sha256:}"
            sig_ref="${image}:sha256-${hex}.sig"
          fi

          echo "signature_ref=$sig_ref" >> "$GITHUB_OUTPUT"
          echo "Signed: ${image}@${digest}"
          echo "Signature ref: ${sig_ref}"

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.image.outputs.image }}@${{ steps.image.outputs.digest }}
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
          format: spdx-json
          output-file: sbom.spdx.json
          upload-artifact: false
          upload-release-assets: false

      - name: Cosign keyless attest SBOM (digest)
        shell: bash
        run: |
          set -euo pipefail
          cosign attest --yes --type spdxjson --predicate sbom.spdx.json "${{ steps.image.outputs.image }}@${{ steps.image.outputs.digest }}"
